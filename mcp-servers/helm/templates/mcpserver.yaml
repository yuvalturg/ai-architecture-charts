{{- $root := . }}
{{- $canDeploy := include "mcp-servers.canDeployMCPServer" . }}
{{- $servers := include "mcp-servers.mergeMcpServers" . | fromJson }}
{{- range $key, $server := $servers }}
{{- $deploymentMode := $server.deploymentMode | default "auto" }}
{{- $useMCPServer := false }}
{{- if eq $deploymentMode "mcpserver" }}
  {{- $useMCPServer = true }}
{{- else if eq $deploymentMode "auto" }}
  {{- $useMCPServer = eq $canDeploy "true" }}
{{- end }}
{{- if and $server.enabled $useMCPServer }}
{{- $serverDict := dict "root" $root "key" $key "server" $server }}
---
apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPServer
metadata:
  name: {{ $key }}
  labels:
    {{- include "mcp-servers.labels" $serverDict | nindent 4 }}
spec:
  image: "{{ $server.image.repository }}:{{ $server.image.tag | default $root.Chart.Version }}"
  proxyMode: {{ $server.proxyMode | default "sse" }}
  transport: {{ $server.transport | default "stdio" }}
  {{- with $server.port }}
  port: {{ . }}
  {{- end }}
  {{- with $server.targetPort }}
  targetPort: {{ . }}
  {{- end }}
  {{- with $server.permissionProfile }}
  permissionProfile:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- if or $server.env $server.envSecrets }}
  env:
  {{- with $server.env }}
  {{- range $envKey, $envValue := . }}
  - name: {{ $envKey }}
    value: {{ $envValue | default "" | quote }}
  {{- end }}
  {{- end }}
  {{- with $server.envSecrets }}
  {{- range $envKey, $secretSpec := . }}
  - name: {{ $envKey }}
    valueFrom:
      secretKeyRef:
        name: {{ $secretSpec.name }}
        key: {{ $secretSpec.key }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if or $server.securityContext $server.podSecurityContext $server.volumes $server.volumeMounts $server.resources $server.secretMounts }}
  podTemplateSpec:
    spec:
      {{- with $server.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if or $server.volumes $server.secretMounts }}
      volumes:
        {{- with $server.volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if $server.secretMounts }}
        {{- range $server.secretMounts.secrets }}
        - name: {{ . }}
          secret:
            secretName: {{ . }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- if or $server.securityContext $server.volumeMounts $server.resources $server.secretMounts }}
      containers:
      - name: mcp
        {{- with $server.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- if or $server.volumeMounts $server.secretMounts }}
        volumeMounts:
          {{- with $server.volumeMounts }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
          {{- if $server.secretMounts }}
          {{- range $server.secretMounts.secrets }}
          - name: {{ . }}
            mountPath: {{ $server.secretMounts.mountPath }}/{{ . }}
            readOnly: true
          {{- end }}
          {{- end }}
        {{- end }}
        {{- with $server.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
  {{- end }}
{{- end }}
{{- end }}
